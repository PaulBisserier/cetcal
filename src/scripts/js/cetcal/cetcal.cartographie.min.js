$('#mapid').height(420);
var mymap = L.map('mapid').setView([44.854, -0.043], 10);
var cetAnnuaireIcon = L.icon({
    iconUrl: 'res/content/icons/PinClipart.com_agriculture-clipart-free_1225806.png',
    iconSize: [38, 38],
    popupAnchor:  [0, -20]
});
var relaodForwardGeocoding = false;
L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1,
    accessToken: 'pk.eyJ1IjoiY2V0Y2FsIiwiYSI6ImNrYzllZ2ZyczEzeTAyd3BoYjBiMTJ2bzMifQ.QdHZsjNjHQ_LQbMOGfbceQ'
}).addTo(mymap);

if (relaodForwardGeocoding) {

    $('producteur').each(function(i) {
        var adrcrt = $(this).find('addresscrt').text();
        var pk = $(this).find('pk').text();
        seak(adrcrt, this);
    });

    function seak(addressParam, node) {
        $.get('https://api.mapbox.com/geocoding/v5/mapbox.places/' + addressParam + 
            '.json?limit=1&country=FR&access_token=pk.eyJ1IjoiY2V0Y2FsIiwiYSI6ImNrYzllZ2ZyczEzeTAyd3BoYjBiMTJ2bzMifQ.QdHZsjNjHQ_LQbMOGfbceQ', 
            function(data, status) {
                var cLl = forwardGeocoder(data);
                L.marker([cLl[1], cLl[0]], {icon: cetAnnuaireIcon}).addTo(mymap);
                $(node).append('<latlng>' + cLl[1] + '/' + cLl[0] + '</latlng>');
        });
    }

} else {

    $('producteur').each(function(i) {

        var adrcrt = $(this).find('addresscrt').text();
        var coordinatesLl = $(this).find('latlng').text().split('/');
        let adr = $(this).find('address').text();
        let email = $(this).find('email').text();
        let np = $(this).find('nom').text() + ' ' + $(this).find('prenom').text();
        let nomFerme = $(this).find('nomferme').text(); 
        let urlwww = $(this).find('urlwww').text();
        if (urlwww.length > 3 && (urlwww.indexOf('http://') < 0 || urlwww.indexOf('https://') < 0)) 
            urlwww = 'http://' + urlwww;
        let urlwwwboutique = $(this).find('urlboutique').text();
        if (urlwwwboutique.length > 3 && (urlwwwboutique.indexOf('http://') < 0 || 
            urlwwwboutique.indexOf('https://') < 0)) urlwwwboutique = 'http://' + urlwwwboutique;
        let fb = $(this).find('urlfb').text();
        let ig = $(this).find('urlig').text();
        if (fb.length > 3 && (fb.indexOf('http://') < 0 || fb.indexOf('https://'))) fb = 'http://' + fb;
        if (ig.length > 3 && (ig.indexOf('http://www.instagram') < 0 || 
            ig.indexOf('https://www.instagram'))) ig = 'https://www.instagram.com/' + ig;
        
        var popupContent = '<p class="cet-cartographie-popup">' + 
            '<a class="btn btn-info btn-sm btn-block cet-an-crt-btn" href="#">' + nomFerme + '</a><br>' + 
            adr + '<br><email>' + email + '</email>';
        if (urlwww.length > 3) popupContent += 
            '<br><a href="' + urlwww + '" target="_blank">Visiter le site Web</a>';
        if (urlwwwboutique.length > 3) popupContent += 
            '<br><a href="' + urlwwwboutique + '" target="_blank">Visiter la boutique en ligne</a>';
        popupContent += '<br><a class="cet-crt-link" href="#">Voir la fiche détaillée</a>';
        popupContent += '<br>'; // back to line for social media icon links.
        if (fb.length > 3) popupContent += 
            '<a href="' + fb + '" target="_blank"><img class="cet-crt-icon" src="/res/content/icons/fb_icon-128.png" height="20"/></a>';
        if (ig.length > 3) popupContent += 
            '<a href="' + ig + '" target="_blank"><img class="cet-crt-icon" src="/res/content/icons/ig_icon-128.png" height="20" /></a>';
        popupContent += '</p>'; // close the P.
 
        L.marker([coordinatesLl[0], coordinatesLl[1]], {icon: cetAnnuaireIcon}
            ).addTo(mymap).bindPopup(popupContent);
    });
}

/** ***********************************************************
 * Helper functions :
 */
function forwardGeocoder(data) {

	for (var i = 0; i < data.features.length; i++) {
		var feature = data.features[i];
		if (feature.geometry.coordinates !== 'undefined') {
			return feature.geometry.coordinates;
		}
	}
	return 'undefined';
}