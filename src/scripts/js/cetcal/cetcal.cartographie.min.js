$('#cet-annuaire-crt-main').height(220);
var htmlMiniFiche = '';
var cetcrtmainmap = L.map('cet-annuaire-crt-main').setView([44.854, -0.043], 9);
var cetAnnuaireIcon = L.icon({
    iconUrl: 'res/content/icons/ferme-rouge.png',
    iconSize: [38, 38],
    popupAnchor:  [0, -20]
});

L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1,
    accessToken: 'pk.eyJ1IjoiY2V0Y2FsIiwiYSI6ImNrYzllZ2ZyczEzeTAyd3BoYjBiMTJ2bzMifQ.QdHZsjNjHQ_LQbMOGfbceQ'
}).addTo(cetcrtmainmap);

$('producteur').each(function(i) {

    var adrcrt = $(this).find('addresscrt').text();
    var coordinatesLl = $(this).find('latlng').text().split('/');
    let adr = $(this).find('address').text();
    let email = $(this).find('email').text();
    let np = $(this).find('nom').text() + ' ' + $(this).find('prenom').text();
    let nomFerme = $(this).find('nomferme').text(); 
    let urlwww = $(this).find('urlwww').text().toLowerCase();
    let urlwwwboutique = $(this).find('urlboutique').text().toLowerCase();
    var fb = $(this).find('urlfb').text();
    var ig = $(this).find('urlig').text();
    if (ig.length > 3 && (ig.indexOf('http://www.instagram') < 0 || 
        ig.indexOf('https://www.instagram') < 0)) ig = 'https://www.instagram.com/' + ig;
    var htmlFB = '';
    var htmlIG = '';
    var htmlMiniFiche = '<p class="cet-cartographie-popup">' + 
        '<a class="cet-ann-crt-head-text" href="#">' + nomFerme + '</a><br>' + 
        adr + '<br><email>' + email + '</email>';
    if (urlwww.length > 3) htmlMiniFiche += 
        '<br><a href="' + urlwww + '" target="_blank">Visiter le site Web</a>';
    if (urlwwwboutique.length > 3) htmlMiniFiche += 
        '<br><a href="' + urlwwwboutique + '" target="_blank">Visiter la boutique en ligne</a>';
    htmlMiniFiche += '<br><a class="cet-crt-link" href="#">Voir la fiche détaillée</a>';
    htmlMiniFiche += '<br>'; // back to line for social media icon links.
    if (fb.length > 3) htmlFB = 
        '<a href="' + fb + '" target="_blank"><img class="cet-crt-icon" src="/res/content/icons/facebook-flat-icon.png" height="20"/></a>';
    htmlMiniFiche += htmlFB;
    if (ig.length > 3) htmlIG = 
        '<a href="' + ig + '" target="_blank"><img class="cet-crt-icon" src="/res/content/icons/ig-flat-icon_256.png" height="20" /></a>';
    htmlMiniFiche += htmlIG;
    htmlMiniFiche += '</p>'; // close the P.

    var marker = L.marker([coordinatesLl[1], coordinatesLl[0]], {icon: cetAnnuaireIcon}
        ).addTo(cetcrtmainmap);
    var popupOptions = {};
    var popup = L.popup(popupOptions, marker);
    popup.setContent('<span class="cet-ann-crt-popuptext">' + nomFerme + '</span><br>' + htmlFB + htmlIG);
    marker.bindPopup(popup).on('popupopen', function() {
        $('#cet-annuaire-crt-mini-fiche-producteur').html(htmlMiniFiche);
        $('#cet-annuaire-crt-mini-fiche-producteur').find('.cet-crt-icon').attr('height', '40');
        $('#cet-annuaire-crt-mini-fiche-producteur-container').show();
    }).on('popupclose', function() {
        $('#cet-annuaire-crt-mini-fiche-producteur').html('');
        $('#cet-annuaire-crt-mini-fiche-producteur-container').hide();
    });

});

L.Control.RemoveAll = L.Control.extend(
{
    options:
    {
        position: 'topright',
    },
    onAdd: function(map) {
        var controlSpan = L.DomUtil.create('span', 'cet-ann-crt-ctrl-container');
        var controlUI = L.DomUtil.create('a', 'cet-ann-crt-ctrl-a', controlSpan);
        controlUI.title = 'Agrandir la carte';
        controlUI.href = '#';
        controlUI.id = 'cet-ann-crt-ctrl-a-id';
        controlUI.type = 'button';

        var img = L.DomUtil.create('img', 'cet-ann-crt-ctrl-icon', controlUI);
        img.src = '/res/content/icons/fullscreen-win_crt.png';
        img.style.height = '30px';
        img.id = 'cet-ann-crt-ctrl-enlarge';
        L.DomEvent
            .addListener(controlSpan, 'click', L.DomEvent.stopPropagation)
            .addListener(controlSpan, 'click', L.DomEvent.preventDefault)
            .addListener(controlSpan, 'click', function () {
                var enlargedHeight = 460, smallHeight = 240;
                var largeCol = 'col-lg-9', smallCol = 'col-lg-6', smallerCol = 'col-lg-3';
                var enlarge = $('#cet-annuaire-crt-main').height() < enlargedHeight;
                if (enlarge) {
                    $('#cet-annuaire-crt-main').height(enlargedHeight);
                    $('#cet-annuaire-crt-bootstrap-wrapper').removeClass(smallCol).addClass(largeCol);
                    $('#cet-ann-crt-ctrl-enlarge').attr('src', '/res/content/icons/unfullscreen-win_crt.png');
                } else {
                    $('#cet-annuaire-crt-main').height(smallHeight);
                    $('#cet-annuaire-crt-bootstrap-wrapper').removeClass(largeCol).addClass(smallCol);
                    $('#cet-ann-crt-ctrl-enlarge').attr('src', '/res/content/icons/fullscreen-win_crt.png');
                }
                cetcrtmainmap.invalidateSize();

            });

        return controlSpan;
    }
});

var removeAllControl = new L.Control.RemoveAll();
cetcrtmainmap.addControl(removeAllControl);