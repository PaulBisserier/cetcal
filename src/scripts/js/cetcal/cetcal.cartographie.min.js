$('#cet-annuaire-crt-main').height(400);
var htmlMiniFiche = '';
var cetcrtmainmap = L.map('cet-annuaire-crt-main').setView([44.854, -0.043], 10);
var cetAnnuaireIcon = L.icon({
    iconUrl: 'res/content/icons/PinClipart.com_agriculture-clipart-free_1225806.png',
    iconSize: [38, 38],
    popupAnchor:  [0, -20]
});

L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1,
    accessToken: 'pk.eyJ1IjoiY2V0Y2FsIiwiYSI6ImNrYzllZ2ZyczEzeTAyd3BoYjBiMTJ2bzMifQ.QdHZsjNjHQ_LQbMOGfbceQ'
}).addTo(cetcrtmainmap);

$('producteur').each(function(i) {

    var adrcrt = $(this).find('addresscrt').text();
    var coordinatesLl = $(this).find('latlng').text().split('/');
    let adr = $(this).find('address').text();
    let email = $(this).find('email').text();
    let np = $(this).find('nom').text() + ' ' + $(this).find('prenom').text();
    let nomFerme = $(this).find('nomferme').text(); 
    let urlwww = $(this).find('urlwww').text().toLowerCase();
    let urlwwwboutique = $(this).find('urlboutique').text().toLowerCase();
    let fb = $(this).find('urlfb').text();
    let ig = $(this).find('urlig').text();
    if (fb.length > 3 && (fb.indexOf('http://') < 0 || fb.indexOf('https://') < 0)) fb = 'http://' + fb;
    if (ig.length > 3 && (ig.indexOf('http://www.instagram') < 0 || 
        ig.indexOf('https://www.instagram') < 0)) ig = 'https://www.instagram.com/' + ig;

    var htmlFB = '';
    var htmlIG = '';
    var htmlMiniFiche = '<p class="cet-cartographie-popup">' + 
        '<a class="cet-ann-crt-head-text" href="#">' + nomFerme + '</a><br>' + 
        adr + '<br><email>' + email + '</email>';
    if (urlwww.length > 3) htmlMiniFiche += 
        '<br><a href="' + urlwww + '" target="_blank">Visiter le site Web</a>';
    if (urlwwwboutique.length > 3) htmlMiniFiche += 
        '<br><a href="' + urlwwwboutique + '" target="_blank">Visiter la boutique en ligne</a>';
    htmlMiniFiche += '<br><a class="cet-crt-link" href="#">Voir la fiche détaillée</a>';
    htmlMiniFiche += '<br>'; // back to line for social media icon links.
    if (fb.length > 3) htmlFB = 
        '<a href="' + fb + '" target="_blank"><img class="cet-crt-icon" src="/res/content/icons/facebook-flat-icon.png" height="20"/></a>';
    htmlMiniFiche += htmlFB;
    if (ig.length > 3) htmlIG = 
        '<a href="' + ig + '" target="_blank"><img class="cet-crt-icon" src="/res/content/icons/ig-flat-icon_256.png" height="20" /></a>';
    htmlMiniFiche += htmlIG;
    htmlMiniFiche += '</p>'; // close the P.

    var marker = L.marker([coordinatesLl[1], coordinatesLl[0]], {icon: cetAnnuaireIcon}
        ).addTo(cetcrtmainmap);
    var popupOptions = {};
    var popup = L.popup(popupOptions, marker);
    popup.setContent('<span class="cet-ann-crt-popuptext">' + nomFerme + '</span><br>' + htmlFB + htmlIG);
    marker.bindPopup(popup).on('popupopen', function() {
        $('#cet-annuaire-crt-mini-fiche-producteur').html(htmlMiniFiche);
        $('#cet-annuaire-crt-mini-fiche-producteur').find('.cet-crt-icon').attr('height', '40');
        $('#cet-annuaire-crt-mini-fiche-producteur-container').show();
    }).on('popupclose', function() {
        $('#cet-annuaire-crt-mini-fiche-producteur').html('');
        $('#cet-annuaire-crt-mini-fiche-producteur-container').hide();
    });

});